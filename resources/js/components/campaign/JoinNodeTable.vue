<template>
    <div>
        <v-data-table
            v-if="showTable"
            :headers="headers"
            :items="filteredItems"
            item-key="node"
            disable-sort
            hide-default-footer
            :hide-default-header="true"
            disable-pagination
            class="pl-15"
        >
            <template v-slot:item.charname="{ item }">
                <div class=" d-inline-flex align-items-center">
                    <div class=" d-inline-flex align-items-center">
                        {{ item.charname }}
                    </div>
                </div>
            </template>
            <template v-slot:item.statusName="{ item }">
                <v-menu offset-y>
                    <template v-slot:activator="{ on, attrs }">
                        <div>
                            <v-chip
                                v-bind="attrs"
                                v-on="on"
                                pill
                                outlined
                                small
                                :color="pillColor(item)"
                            >
                                {{ item.statusName }}
                            </v-chip>
                        </div>
                    </template>

                    <v-list>
                        <v-list-item
                            v-for="(list, index) in dropdown_edit"
                            :key="index"
                            @click="
                                (item.campaign_system_status_id = list.value),
                                    (item.statusName = list.title),
                                    statusClick(item)
                            "
                        >
                            <v-list-item-title>{{
                                list.title
                            }}</v-list-item-title>
                        </v-list-item>
                    </v-list>
                </v-menu>
            </template>
            <template v-slot:item.ship="{ item }">
                <span v-if="item.charname != null">
                    {{ item.ship }} - T{{ item.link }}
                </span>
            </template>
            <template v-slot:item.actions="{ item }">
                <v-icon
                    v-if="
                        item.campaign_system_status_id != 4 &&
                            item.campaign_system_status_id != 5
                    "
                    color="orange darken-3"
                    small
                    @click="deleteNode(item)"
                >
                    fas fa-trash-alt
                </v-icon>
            </template>
        </v-data-table>
    </div>
</template>

<script>
import { mapGetters } from "vuex";
import { mapState } from "vuex";
export default {
    props: {
        sysid: Number
    },
    data() {
        return {
            headers: [
                {
                    text: "Pilot",
                    value: "charname",
                    align: "start"
                },
                {
                    text: "Main",
                    value: "mainname",
                    align: "start"
                },
                {
                    text: "Ship",
                    value: "ship",
                    align: "start"
                },
                {
                    text: "Status",
                    value: "statusName",
                    align: "start"
                },
                { text: "", value: "actions", align: "start" }
            ],

            dropdown_edit: [
                { title: "New", value: 1 },
                { title: "Warm up", value: 2 },
                { title: "Hacking", value: 3 },
                { title: "Pushed off", value: 6 }
            ],
            expanded: [],
            singleExpand: false
        };
    },

    methods: {
        pillColor(item) {
            if (item.campaign_system_status_id == 1) {
                return "deep-orange lighten-1";
            }
            if (item.campaign_system_status_id == 2) {
                return "lime darken-4";
            }
            if (item.campaign_system_status_id == 3) {
                return "green darken-3";
            }
            if (item.campaign_system_status_id == 6) {
                return "FF5EEA";
            }
        },

        checkShowAddRemove(item) {
            if (
                item.charname != null &&
                this.charCount != 0 &&
                item.campaign_system_status_id != 4 &&
                item.campaign_system_status_id != 5 &&
                item.campaign_system_status_id != 7 &&
                item.campaign_system_status_id != 8
            ) {
                return true;
            } else if (this.$can("campaigns_admin_access")) {
                return true;
            } else {
                return false;
            }
        },

        async deleteNode(item) {
            await axios({
                method: "PUT", //you can set what request you want to be
                url: "/api/deleteextranode/" + item.id + "/" + item.campaign_id,
                headers: {
                    Authorization: "Bearer " + this.$store.state.token,
                    Accept: "application/json",
                    "Content-Type": "application/json"
                }
            });
        },

        async statusClick(item) {
            var request = [];
            if (
                item.campaign_system_status_id == 2 ||
                item.campaign_system_status_id == 3
            ) {
                request = {
                    campaign_system_status_id: item.campaign_system_status_id
                };
            }
            if (item.campaign_system_status_id == 6) {
                await this.deleteNode(item);
                return;
            }
            await axios({
                method: "put", //you can set what request you want to be
                url: "/api/nodejoinupdate/" + item.id + "/" + item.campaign_id,
                data: request,
                headers: {
                    Authorization: "Bearer " + this.$store.state.token,
                    Accept: "application/json",
                    "Content-Type": "application/json"
                }
            });
        }
    },

    computed: {
        ...mapGetters([
            "getNodeJoinByNode",
            "getNodeJoinByNodeCount",
            "getCampaignUsersByUserIdEntosisCount"
        ]),

        filteredItems() {
            console.log(this.sysid);
            return this.getNodeJoinByNode(this.sysid);
        },

        showTable() {
            if (this.getNodeJoinByNodeCount(this.sysid) > 0) {
                return true;
            } else {
                return false;
            }
        },

        charCount() {
            return this.getCampaignUsersByUserIdEntosisCount(
                this.$store.state.user_id
            );
        }
    }
};
</script>

<style></style>
